rules_version = '2';

/**
 * Firestore Security Rules for Bench Prediction Market
 * 
 * UPDATED: Allows wallet-based access (no Firebase auth required)
 * 
 * Security model:
 * 1. Markets are public (read-only)
 * 2. Cloud Functions handle all writes (validated server-side)
 * 3. Users can read their own data using wallet address
 * 
 * Note: This is suitable for development. For production, consider
 * adding authentication or using App Check for additional security.
 */
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Markets collection - PUBLIC READ
    // Anyone can read markets (no auth required)
    match /markets/{marketId} {
      // Public read access
      allow read: if true;
      
      // Only Cloud Functions can write (via service account)
      allow write: if false;
      
      // Options subcollection - PUBLIC READ
      match /options/{optionId} {
        allow read: if true;
        allow write: if false;
      }
    }
    
    // Users collection - WALLET-BASED ACCESS
    // Users can read/write using wallet address (no auth required)
    match /users/{walletAddress} {
      // Anyone can read (for now - tighten in production)
      allow read: if true;
      
      // Cloud Functions can write (via service account)
      // Also allow direct writes for user profile creation
      allow write: if true;
    }
    
    // Positions collection - PUBLIC READ, ALLOW CREATE
    // Users can read their own positions
    // Users can CREATE positions (after blockchain transaction)
    // Only Cloud Functions can update/delete
    match /positions/{positionId} {
      // Anyone can read (filter by userId client-side)
      allow read: if true;
      
      // Allow position creation from frontend (for blockchain bets)
      allow create: if true;
      
      // Only Cloud Functions can update/delete
      allow update, delete: if false;
    }
    
    // Admins collection - PUBLIC READ
    match /admins/{adminId} {
      allow read: if true;
      allow write: if false;
    }
  }
}


